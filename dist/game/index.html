<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src='https://unpkg.com/axios/dist/axios.min.js'></script>
  <style>
table {
  height: 90vh;
  width: 90vw;
  max-width: 120vh;
  margin: 15px auto;
  border: 2px solid black;
  border-collapse: seperate;
  border-spacing: 4px;
}
td {
  border: 2px solid rgb(187, 187, 187);
  background: rgb(223, 220, 185);
}
.assassin {
  background: black;
}
.agent {
  background: rgb(29, 165, 72);
}
.front {
  background: white;
  color: rgb(31, 94, 31);
  border-width: 1px;
  text-align: center;
  font-size: 2rem;
  height: 2.5rem;
}
nav {
  display:flex;
  flex-direction: row;
  justify-content: space-around;
}
</style>
</head>
<body>
  <nav>
    <button id="return">New Game</button>
    <button id="share">Share</button>
    <button id="rotate">Flip</button>
  </nav>
  <table id='game_board'>
    <tr>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
    </tr>
  </table>
</body>
<script>
  const game_state = {
    isRotated: false,
    agents: 0,
    assassins: 0,
    player: 0,
    gameID: 0
  }

  // convert board bytes to html
  function mapBoard() {
    let agents = game_state.agents;
    let assassins = game_state.assassins;
    let board = Array(5).fill().map(() => Array(5).fill());

    for (let i = 0; i < 25; i++) {
      let htmlClass = ''
      if (agents % 2 === 1) {
        htmlClass = ' class="agent"';
      } else if (assassins % 2 === 1) {
        htmlClass = ' class="assassin"';
      }
      board[i%5][Math.floor(i / 5)] = `<td${htmlClass}></td>`;
      agents >>= 1;
      assassins >>= 1;
    }
    return board;
  }

  // render board to the dom
  function renderBoard() {
    let isRotated = game_state.isRotated;

    let board = mapBoard();
    
    if (isRotated) board = board.reverse().map(v => v.reverse());

    let rows = board.map(row => `<tr>${row.join('')}</tr>`);

    let table = document.getElementById('game_board');

    let front = `<tr${isRotated ? ' style="transform: rotate(180deg);"' : ''}><td colspan="5" class="front">FRONT</td></tr>`

    table.innerHTML = `
    ${isRotated ? front : ''}
    ${rows.join('')}
    ${isRotated ? '' : front}`;
  }

  function attachListeners() {
    document.getElementById('share').onclick = () => {
      let link = window.location.href;
      link = link.slice(0, link.length - 1);
      let player = game_state.player % 2 + 1;
      window.alert(`Share me:\n ${link + player}`);
    };

    document.getElementById('rotate').onclick = () => {
      game_state.isRotated = !game_state.isRotated;
      renderBoard();
    };


    document.getElementById('return').onclick = () => {
      window.location.replace('/');
    };
  }

  (() => {
    // request the game id, for player
    let url = window.location.search;
    let params = url.slice(1).split('&').map(str => str.split('=')).flat();
    game_state.gameID = params[1];
    game_state.player = params[3]

    console.log(params);

    // get board data
    axios.get(`/api/game?gameID=${game_state.gameID}&player=${game_state.player}`).then(res => {
      console.log('responded');
      game_state.agents = res.data.agents;
      game_state.assassins = res.data.sass;
      console.log('wrote to state');
      console.log('begin render');
      renderBoard();
      attachListeners();
    }).catch(e => console.log(e));
  })();

</script>
</html>